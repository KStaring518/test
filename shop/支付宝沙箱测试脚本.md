# 支付宝沙箱测试脚本

## 问题诊断

从你的情况看，支付宝沙箱显示"系统繁忙"错误，这通常是因为：

1. **沙箱环境不稳定** - 支付宝沙箱经常出现临时问题
2. **应用配置问题** - 应用ID或密钥可能有问题
3. **回调地址验证失败** - 支付宝无法验证回调地址

## 测试步骤

### 1. 验证ngrok地址可访问性

```bash
# 测试回调地址是否可访问
curl -I https://9949aa6a4448.ngrok-free.app/api/alipay/notify
curl -I https://9949aa6a4448.ngrok-free.app/api/alipay/redirect
```

### 2. 检查支付宝沙箱应用状态

访问：https://open.alipay.com/develop/manage

检查你的沙箱应用：
- 应用ID: 9021000151650950
- 应用状态：是否正常
- 密钥配置：是否正确

### 3. 使用正确的沙箱测试账号

确保使用不同的买家和卖家账号：

**买家账号**（用于支付）：
- 账号：nkl***@sandbox.com
- 密码：111111

**卖家账号**（收款方）：
- 账号：lvqgcy4876@sandbox.com
- 密码：111111

### 4. 检查订单参数

确保订单参数正确：
- 订单号唯一性
- 金额格式正确
- 商品描述正确

## 解决方案

### 方案1：修复沙箱配置

1. **重新生成密钥对**
2. **更新应用配置**
3. **验证回调地址**

### 方案2：使用模拟支付（推荐）

如果沙箱环境持续不稳定，建议使用模拟支付：

```http
POST {{base_url}}/order/pay/mock
Authorization: Bearer {{token_user}}
Content-Type: application/json

{
  "orderNo": "{{test_order_no}}"
}
```

### 方案3：检查网络和防火墙

1. **检查防火墙设置**
2. **检查网络连接**
3. **检查代理设置**

## 调试信息

从日志可以看到：
- 支付订单创建成功：`[Alipay][Create] success for order Odff9963ed7404deaa7, amount=14.00`
- 网关地址正确：`https://openapi-sandbox.dl.alipaydev.com/gateway.do`
- ngrok地址已更新：`https://9949aa6a4448.ngrok-free.app`

## 建议

1. **等待一段时间** - 沙箱环境可能正在维护
2. **使用模拟支付** - 确保功能测试正常
3. **检查支付宝开放平台** - 确认应用状态
4. **联系支付宝技术支持** - 如果问题持续

## 测试命令

```bash
# 测试回调地址
curl -X POST https://9949aa6a4448.ngrok-free.app/api/alipay/notify \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "test=1"

# 测试重定向地址
curl -I https://9949aa6a4448.ngrok-free.app/api/alipay/redirect
```
