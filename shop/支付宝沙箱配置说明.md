# 支付宝沙箱支付配置说明

## 🎯 概述

本文档说明如何在零食商城系统中集成支付宝沙箱支付功能。支付宝沙箱环境可以模拟真实的支付流程，是开发和测试阶段的理想选择。

## 📋 前置条件

### 1. 支付宝开放平台账号
- 注册支付宝开放平台账号：https://open.alipay.com/
- 完成实名认证
- 创建沙箱应用

### 2. 沙箱环境信息
- 沙箱网关：https://openapi.alipaydev.com/gateway.do
- 沙箱应用ID：以 `2021000122` 开头的数字
- 沙箱账号：用于测试的买家账号

## 🔧 配置步骤

### 步骤1：获取沙箱应用信息

1. 登录支付宝开放平台
2. 进入"沙箱环境"
3. 创建沙箱应用
4. 记录以下信息：
   - 应用ID (APPID)
   - 应用私钥 (RSA2_PRIVATE_KEY)
   - 支付宝公钥 (ALIPAY_PUBLIC_KEY)

### 步骤2：生成RSA密钥对

```bash
# 生成私钥
openssl genrsa -out private_key.pem 2048

# 生成公钥
openssl rsa -in private_key.pem -pubout -out public_key.pem
```

### 步骤3：配置应用参数

在 `src/main/resources/application.yml` 中配置：

```yaml
alipay:
  gateway-url: https://openapi.alipaydev.com/gateway.do
  app-id: 你的沙箱应用ID
  merchant-private-key: 你的应用私钥
  alipay-public-key: 支付宝公钥
  notify-url: http://localhost:8080/api/alipay/notify
  return-url: http://localhost:3000/payment/return
  charset: UTF-8
  format: json
  sign-type: RSA2
```

### 步骤4：获取沙箱账号

在沙箱环境中获取：
- 买家账号（用于测试支付）
- 卖家账号（用于测试收款）

## 🚀 使用方法

### 1. 启动系统
```bash
# 后端
mvn spring-boot:run

# 前端
npm run dev
```

### 2. 测试支付流程
1. 创建订单
2. 选择"支付宝支付"
3. 使用沙箱买家账号登录
4. 完成支付测试

## 🔍 常见问题

### Q1: 应用私钥格式错误
**A**: 确保私钥是PEM格式，包含完整的头部和尾部：
```
-----BEGIN RSA PRIVATE KEY-----
...私钥内容...
-----END RSA PRIVATE KEY-----
```

### Q2: 签名验证失败
**A**: 检查以下配置：
- 签名算法是否为RSA2
- 字符编码是否为UTF-8
- 时间戳是否正确

### Q3: 异步通知失败
**A**: 确保：
- 通知地址可访问
- 网络连接正常
- 服务器能接收POST请求

## 📱 沙箱账号信息

### 买家账号
- 账号：`qjqjqjqjqjqj`
- 登录密码：`111111`
- 支付密码：`111111`

### 卖家账号
- 账号：`qjqjqjqjqjqj`
- 登录密码：`111111`

## 🔒 安全注意事项

1. **私钥安全**：应用私钥必须保密，不能泄露
2. **HTTPS**：生产环境必须使用HTTPS
3. **签名验证**：必须验证支付宝回调的签名
4. **金额验证**：验证支付金额与订单金额一致

## 📚 相关文档

- [支付宝开放平台文档](https://opendocs.alipay.com/)
- [沙箱环境使用指南](https://opendocs.alipay.com/common/02kkv7)
- [RSA2签名算法说明](https://opendocs.alipay.com/common/02mse3)

## 🎉 测试完成

配置完成后，你可以：
1. 使用沙箱账号进行支付测试
2. 验证支付流程的完整性
3. 测试异步通知机制
4. 验证订单状态更新

## 📞 技术支持

如遇到问题，请检查：
1. 配置文件是否正确
2. 网络连接是否正常
3. 日志信息是否有错误
4. 支付宝沙箱环境是否正常
ngrok.exe http 8080