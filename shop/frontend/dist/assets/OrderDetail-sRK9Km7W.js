import{d as ie,r as _,o as re,c as d,a,w as l,b as c,q as de,E as p,f as t,h as u,j as g,i as R,F as D,t as r,g as y,k as E,u as ue,e as i,x as z}from"./index-jh95nJwH.js";import{u as ce}from"./user-TGyX2SHZ.js";import{d as ve,e as me,c as pe,b as _e}from"./order-3D-lLFhF.js";import{c as fe,l as ye}from"./review-DwHL5sf7.js";import{_ as ge}from"./_plugin-vue_export-helper-BDJoutlP.js";const ke={class:"order-detail-page"},we={class:"header-content"},he={class:"user-info"},Ie={class:"order-detail-container"},be={class:"back-section"},Ce={key:0,class:"loading-section"},De={key:1,class:"order-detail"},xe={class:"order-header"},Ne={class:"order-basic-info"},Se={class:"order-no"},Ve={class:"order-time"},Ae={class:"order-status"},Pe={class:"order-items-section"},Re={key:0,class:"empty-items"},Ee={key:1,class:"order-items"},Te={class:"item-image"},$e=["src","alt"],Be={class:"item-info"},Le={class:"item-subtitle"},Oe={class:"item-price"},Ue={class:"item-total"},ze={class:"item-actions"},Me={key:0,class:"reviews-panel"},Fe={key:0,style:{padding:"8px 0"}},He={key:1},qe={class:"review-header"},je={class:"reviewer-name"},Ge={class:"review-time"},Je={class:"review-content"},Ke={class:"delivery-section"},Qe={class:"delivery-info"},We={class:"info-item"},Xe={class:"value"},Ye={class:"info-item"},Ze={class:"value"},et={class:"info-item"},tt={class:"value"},st={class:"amount-section"},ot={class:"amount-info"},nt={class:"amount-item"},lt={class:"value"},at={class:"amount-item total"},it={class:"value"},rt={key:0,class:"logistics-section"},dt={class:"logistics-info"},ut={class:"info-item"},ct={class:"value"},vt={class:"info-item"},mt={class:"value"},pt={class:"info-item"},_t={class:"value"},ft={key:0,class:"logistics-tracks"},yt={class:"track-item"},gt={class:"track-location"},kt={class:"track-description"},wt={key:1,class:"remark-section"},ht={class:"remark-content"},It={class:"order-actions"},bt={key:2,class:"error-section"},Ct=ie({__name:"OrderDetail",setup(Dt){const T=ue(),M=de(),w=ce(),o=_(null),$=_(!0),B=_(!1),x=_([]),h=_(!1),N=_(!1),v=_({orderItemId:0,rating:5,content:"",anonymous:!1}),I=_({}),b=_({}),S=_({}),V=async()=>{try{const n=parseInt(M.params.id),e=await ve(n);o.value=e.data,B.value=Number(o.value.userId)===Number(w.user?.id),console.log("订单详情数据:",e.data),console.log("订单项数量:",e.data.orderItems?.length||0),o.value.shipment&&await F(o.value.shipment.id)}catch(n){console.error("加载订单详情失败:",n),p.error("加载订单详情失败")}finally{$.value=!1}},F=async n=>{try{const e=await me(n);x.value=e.data,console.log("物流轨迹数据:",e.data)}catch(e){console.error("加载物流轨迹失败:",e),p.error("加载物流轨迹失败")}},H=()=>{o.value&&T.push({path:"/payment",query:{orderNo:o.value.orderNo,totalAmount:String(o.value.totalAmount)}})},q=async()=>{if(o.value)try{await z.confirm("确定已收到商品吗？","确认收货",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await pe(o.value.id),p.success("确认收货成功"),await V()}catch(n){n!=="cancel"&&(console.error("确认收货失败:",n),p.error("确认收货失败"))}},j=async()=>{if(o.value)try{await z.confirm("确定要取消这个订单吗？","确认取消",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await _e(o.value.id),p.success("订单已取消"),await V()}catch(n){n!=="cancel"&&(console.error("取消订单失败:",n),p.error("取消订单失败"))}},G=n=>{v.value={orderItemId:n.id,rating:5,content:"",anonymous:!1},h.value=!0},J=async()=>{try{if(v.value.rating<1||v.value.rating>5){p.warning("评分需在1-5之间");return}N.value=!0,await fe({orderItemId:v.value.orderItemId,rating:v.value.rating,content:v.value.content,anonymous:v.value.anonymous}),p.success("评价已提交"),h.value=!1}catch{p.error("提交失败")}finally{N.value=!1}},L=async n=>{const e=n.id;if(I.value[e]=!I.value[e],I.value[e]&&!b.value[e]){S.value[e]=!0;try{const k=await ye(n.product.id);b.value[e]=k.data||[]}catch{p.error("加载评价失败"),b.value[e]=[]}finally{S.value[e]=!1}}},C=n=>new Date(n).toLocaleString("zh-CN"),K=n=>({UNPAID:"warning",PAID:"primary",SHIPPED:"success",FINISHED:"success",CLOSED:"info"})[n]||"info",Q=n=>({UNPAID:"待付款",PAID:"待发货",SHIPPED:"待收货",FINISHED:"已完成",CLOSED:"已取消"})[n]||n,W=()=>{w.logout(),p.success("退出成功"),T.push("/login")};return re(()=>{w.initUser(),V()}),(n,e)=>{const k=c("el-menu-item"),X=c("el-menu"),m=c("el-button"),Y=c("el-header"),O=c("el-skeleton"),Z=c("el-tag"),A=c("el-empty"),U=c("el-rate"),ee=c("el-timeline-item"),te=c("el-timeline"),P=c("el-form-item"),se=c("el-switch"),oe=c("el-input"),ne=c("el-form"),le=c("el-dialog"),ae=c("el-main");return i(),d("div",ke,[a(Y,{class:"header"},{default:l(()=>[t("div",we,[e[15]||(e[15]=t("div",{class:"logo"},[t("h2",null,"零食商城")],-1)),a(X,{mode:"horizontal",router:!0,class:"nav-menu"},{default:l(()=>[a(k,{index:"/"},{default:l(()=>[...e[9]||(e[9]=[u("首页",-1)])]),_:1}),a(k,{index:"/products"},{default:l(()=>[...e[10]||(e[10]=[u("商品列表",-1)])]),_:1}),a(k,{index:"/cart"},{default:l(()=>[...e[11]||(e[11]=[u("购物车",-1)])]),_:1}),a(k,{index:"/orders"},{default:l(()=>[...e[12]||(e[12]=[u("我的订单",-1)])]),_:1})]),_:1}),t("div",he,[R(w).isLoggedIn()?(i(),d(D,{key:0},[t("span",null,"欢迎，"+r(R(w).user?.nickname||R(w).user?.username),1),a(m,{onClick:W,type:"text"},{default:l(()=>[...e[13]||(e[13]=[u("退出",-1)])]),_:1})],64)):(i(),g(m,{key:1,onClick:e[0]||(e[0]=s=>n.$router.push("/login")),type:"primary"},{default:l(()=>[...e[14]||(e[14]=[u("登录",-1)])]),_:1}))])])]),_:1}),a(ae,{class:"main-content"},{default:l(()=>[t("div",Ie,[t("div",be,[a(m,{onClick:e[1]||(e[1]=s=>n.$router.push("/orders")),type:"text",icon:"ArrowLeft"},{default:l(()=>[...e[16]||(e[16]=[u(" 返回订单列表 ",-1)])]),_:1})]),$.value?(i(),d("div",Ce,[a(O,{rows:10,animated:""})])):o.value?(i(),d("div",De,[t("div",xe,[t("div",Ne,[e[17]||(e[17]=t("h2",null,"订单详情",-1)),t("div",Se,"订单号："+r(o.value.orderNo),1),t("div",Ve,"下单时间："+r(C(o.value.createdAt)),1)]),t("div",Ae,[a(Z,{type:K(o.value.status),size:"large"},{default:l(()=>[u(r(Q(o.value.status)),1)]),_:1},8,["type"])])]),t("div",Pe,[e[18]||(e[18]=t("h3",null,"商品信息",-1)),!o.value.orderItems||o.value.orderItems.length===0?(i(),d("div",Re,[a(A,{description:"暂无商品信息"})])):(i(),d("div",Ee,[(i(!0),d(D,null,E(o.value.orderItems,s=>(i(),d("div",{key:s.id,class:"order-item"},[t("div",Te,[t("img",{src:s.product.coverImage,alt:s.product.name},null,8,$e)]),t("div",Be,[t("h4",null,r(s.product.name),1),t("p",Le,r(s.product.subtitle),1),t("p",Oe,"¥"+r(s.priceSnapshot)+" × "+r(s.quantity),1)]),t("div",Ue," ¥"+r(s.subtotal),1),t("div",ze,[o.value.status==="FINISHED"?(i(),g(m,{key:0,type:s.hasReview?"success":"primary",size:"small",onClick:f=>s.hasReview?L(s):G(s)},{default:l(()=>[u(r(s.hasReview?"查看评价":"去评价"),1)]),_:2},1032,["type","onClick"])):y("",!0),s.hasReview?y("",!0):(i(),g(m,{key:1,type:"info",size:"small",onClick:f=>L(s)},{default:l(()=>[u(r(I.value[s.id]?"收起评价":"查看评价"),1)]),_:2},1032,["onClick"]))]),I.value[s.id]?(i(),d("div",Me,[S.value[s.id]?(i(),d("div",Fe,[a(O,{rows:2,animated:""})])):(i(),d("div",He,[(b.value[s.id]||[]).length===0?(i(),g(A,{key:0,description:"暂无评价"})):(i(!0),d(D,{key:1},E(b.value[s.id],f=>(i(),d("div",{class:"review-item",key:f.id},[t("div",qe,[a(U,{"model-value":f.rating,max:5,disabled:""},null,8,["model-value"]),t("span",je,r(f.isAnonymous?"匿名用户":f.user?.nickname||f.user?.username||"未知用户"),1),t("span",Ge,r(C(f.createdAt)),1)]),t("div",Je,r(f.content||"（无文字）"),1)]))),128))]))])):y("",!0)]))),128))]))]),t("div",Ke,[e[22]||(e[22]=t("h3",null,"收货信息",-1)),t("div",Qe,[t("div",We,[e[19]||(e[19]=t("span",{class:"label"},"收货人：",-1)),t("span",Xe,r(o.value.receiverName),1)]),t("div",Ye,[e[20]||(e[20]=t("span",{class:"label"},"联系电话：",-1)),t("span",Ze,r(o.value.receiverPhone),1)]),t("div",et,[e[21]||(e[21]=t("span",{class:"label"},"收货地址：",-1)),t("span",tt,r(o.value.receiverAddress),1)])])]),t("div",st,[e[25]||(e[25]=t("h3",null,"订单金额",-1)),t("div",ot,[t("div",nt,[e[23]||(e[23]=t("span",{class:"label"},"商品总额：",-1)),t("span",lt,"¥"+r(o.value.totalAmount),1)]),t("div",at,[e[24]||(e[24]=t("span",{class:"label"},"实付金额：",-1)),t("span",it,"¥"+r(o.value.totalAmount),1)])])]),o.value.shipment?(i(),d("div",rt,[e[30]||(e[30]=t("h3",null,"物流信息",-1)),t("div",dt,[t("div",ut,[e[26]||(e[26]=t("span",{class:"label"},"物流公司：",-1)),t("span",ct,r(o.value.shipment.carrier),1)]),t("div",vt,[e[27]||(e[27]=t("span",{class:"label"},"物流单号：",-1)),t("span",mt,r(o.value.shipment.trackingNo),1)]),t("div",pt,[e[28]||(e[28]=t("span",{class:"label"},"发货时间：",-1)),t("span",_t,r(C(o.value.shipment.shippedAt)),1)])]),x.value.length>0?(i(),d("div",ft,[e[29]||(e[29]=t("h4",null,"物流轨迹",-1)),a(te,null,{default:l(()=>[(i(!0),d(D,null,E(x.value,s=>(i(),g(ee,{key:s.id,timestamp:C(s.trackTime),placement:"top"},{default:l(()=>[t("div",yt,[t("div",gt,r(s.location),1),t("div",kt,r(s.description),1)])]),_:2},1032,["timestamp"]))),128))]),_:1})])):y("",!0)])):y("",!0),o.value.remark?(i(),d("div",wt,[e[31]||(e[31]=t("h3",null,"订单备注",-1)),t("div",ht,r(o.value.remark),1)])):y("",!0),t("div",It,[o.value.status==="UNPAID"?(i(),g(m,{key:0,type:"primary",size:"large",onClick:H},{default:l(()=>[...e[32]||(e[32]=[u(" 去支付 ",-1)])]),_:1})):y("",!0),o.value.status==="SHIPPED"&&B.value?(i(),g(m,{key:1,type:"success",size:"large",onClick:q},{default:l(()=>[...e[33]||(e[33]=[u(" 确认收货 ",-1)])]),_:1})):y("",!0),o.value.status==="UNPAID"?(i(),g(m,{key:2,type:"danger",size:"large",onClick:j},{default:l(()=>[...e[34]||(e[34]=[u(" 取消订单 ",-1)])]),_:1})):y("",!0),a(m,{type:"info",size:"large",onClick:e[2]||(e[2]=s=>n.$router.push("/orders"))},{default:l(()=>[...e[35]||(e[35]=[u(" 返回列表 ",-1)])]),_:1})])])):(i(),d("div",bt,[a(A,{description:"订单不存在或已被删除"},{default:l(()=>[a(m,{type:"primary",onClick:e[3]||(e[3]=s=>n.$router.push("/orders"))},{default:l(()=>[...e[36]||(e[36]=[u("返回订单列表",-1)])]),_:1})]),_:1})]))]),a(le,{modelValue:h.value,"onUpdate:modelValue":e[8]||(e[8]=s=>h.value=s),title:"发表评价",width:"520px"},{footer:l(()=>[a(m,{onClick:e[7]||(e[7]=s=>h.value=!1)},{default:l(()=>[...e[37]||(e[37]=[u("取消",-1)])]),_:1}),a(m,{type:"primary",loading:N.value,onClick:J},{default:l(()=>[...e[38]||(e[38]=[u("提交",-1)])]),_:1},8,["loading"])]),default:l(()=>[a(ne,{"label-width":"80px"},{default:l(()=>[a(P,{label:"评分"},{default:l(()=>[a(U,{modelValue:v.value.rating,"onUpdate:modelValue":e[4]||(e[4]=s=>v.value.rating=s),max:5},null,8,["modelValue"])]),_:1}),a(P,{label:"匿名"},{default:l(()=>[a(se,{modelValue:v.value.anonymous,"onUpdate:modelValue":e[5]||(e[5]=s=>v.value.anonymous=s)},null,8,["modelValue"])]),_:1}),a(P,{label:"内容"},{default:l(()=>[a(oe,{modelValue:v.value.content,"onUpdate:modelValue":e[6]||(e[6]=s=>v.value.content=s),type:"textarea",rows:4,placeholder:"说说你的使用感受吧"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})])}}}),Pt=ge(Ct,[["__scopeId","data-v-961e6180"]]);export{Pt as default};
