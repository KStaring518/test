import{d as _e,r as w,l as K,o as fe,c as k,a as t,w as a,b as r,E as m,f as d,h as u,j as V,i as x,F as h,t as L,A as D,k as G,p as ye,g as be,x as j,u as Ie,e as c}from"./index-jh95nJwH.js";import{u as we}from"./user-TGyX2SHZ.js";import{g as ke}from"./product-DW7NrKLf.js";import{d as Ve,u as Ce,e as Se,f as Ue,t as Oe}from"./merchant-BqVm6Od2.js";import{a as M,u as xe}from"./upload-CBboRTXw.js";import{_ as Fe}from"./_plugin-vue_export-helper-BDJoutlP.js";const ze={class:"merchant-products"},Le={class:"header-content"},Ee={class:"user-info"},Pe={class:"products-container"},Ae={class:"page-header"},Ne={class:"filter-section"},Te={class:"products-table"},he={class:"product-image-cell"},Me=["src","alt"],$e={key:1,class:"no-image"},Be={class:"pagination-section"},Re={class:"image-upload-section"},qe=["src"],Ke={class:"image-upload-tips"},De=_e({__name:"MerchantProducts",setup(Ge){const J=Ie(),S=we(),U=w([]),E=w([]),C=w(!1),b=w(null),P=w(!1),$=w(),v=K({categoryId:null,status:"",keyword:""}),p=K({page:1,size:10,total:0}),s=w({name:"",subtitle:"",categoryId:null,price:0,stock:0,unit:"",coverImage:"",description:"",status:"ON_SALE"}),W={name:[{required:!0,message:"请输入商品名称",trigger:"blur"}],categoryId:[{required:!0,message:"请选择商品分类",trigger:"change"}],price:[{required:!0,message:"请输入商品价格",trigger:"blur"}],stock:[{required:!0,message:"请输入商品库存",trigger:"blur"}],unit:[{required:!0,message:"请输入计量单位",trigger:"blur"}]},I=async()=>{try{const{data:o}=await Ve({page:p.page,size:p.size,keyword:v.keyword||void 0,categoryId:v.categoryId||void 0,status:v.status||void 0}),e=o.list||[];U.value=e.map(n=>({...n,coverImage:M(n.coverImage)})),p.total=o.total||0}catch(o){console.error("加载商品列表失败:",o),m.error("加载商品列表失败")}},H=async()=>{try{const o=await ke();E.value=o.data||[]}catch(o){console.error("加载分类失败:",o)}},F=()=>{p.page=1,I()},Q=o=>{p.size=o,p.page=1,I()},X=o=>{p.page=o,I()},Y=o=>{b.value=o,console.log("编辑商品:",o),console.log("商品图片:",o.coverImage),s.value={name:o.name,subtitle:o.subtitle,categoryId:o.category?.id??o.categoryId,price:o.price,stock:o.stock,unit:o.unit,coverImage:M(o.coverImage)||"",description:o.description,status:o.status},console.log("设置后的productForm:",s.value),console.log("设置后的coverImage:",s.value.coverImage),C.value=!0},Z=async()=>{try{await $.value.validate(),P.value=!0,b.value?(await Ce(b.value.id,{name:s.value.name,subtitle:s.value.subtitle,categoryId:Number(s.value.categoryId),coverImage:s.value.coverImage,price:s.value.price,unit:s.value.unit,stock:s.value.stock,description:s.value.description}),m.success("商品更新成功")):(await Se({name:s.value.name,subtitle:s.value.subtitle,categoryId:Number(s.value.categoryId),coverImage:s.value.coverImage,price:s.value.price,unit:s.value.unit,stock:s.value.stock,description:s.value.description}),m.success("商品添加成功")),C.value=!1,te(),I()}catch(o){console.error("操作失败:",o),m.error("操作失败")}finally{P.value=!1}},B=async(o,e)=>{try{const n=e==="ON_SALE"?"上架":"下架";await j.confirm(`确定要${n}这个商品吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Oe(o),m.success(`商品${n}成功`),I()}catch(n){n!=="cancel"&&(console.error("操作失败:",n),m.error("操作失败"))}},ee=async o=>{try{await j.confirm("确定要删除这个商品吗？删除后无法恢复！","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ue(o),m.success("商品删除成功"),I()}catch(e){e!=="cancel"&&(console.error("删除失败:",e),m.error("删除失败"))}},te=()=>{b.value=null,s.value={name:"",subtitle:"",categoryId:null,price:0,stock:0,unit:"",coverImage:"",description:"",status:"ON_SALE"}},le=o=>({ON_SALE:"success",OFF_SALE:"warning",OUT_OF_STOCK:"danger"})[o]||"info",ae=o=>({ON_SALE:"在售",OFF_SALE:"下架",OUT_OF_STOCK:"缺货"})[o]||o,oe=o=>{const e=o.type.startsWith("image/"),n=o.size/1024/1024<5;return e?n?!0:(m.error("图片大小不能超过 5MB!"),!1):(m.error("只能上传图片文件!"),!1)},se=async o=>{try{const e=b.value?.id;console.log("=== 前端图片上传调试 ==="),console.log("商品ID:",e),console.log("文件:",o.file);const n=await xe(o.file,e);console.log("上传响应:",n),console.log("响应数据:",n.data);let g="";if(n.data&&n.data.data)g=n.data.data;else if(n.data&&typeof n.data=="string")g=n.data;else throw new Error("无法解析图片URL");if(console.log("提取的图片URL:",g),g=M(g),console.log("完整图片URL:",g),s.value.coverImage=g,console.log("设置后的coverImage:",s.value.coverImage),e&&U.value.length>0){const i=U.value.findIndex(A=>A.id===e);i!==-1&&(U.value[i].coverImage=g)}m.success("图片上传成功")}catch(e){console.error("图片上传失败:",e),m.error("图片上传失败")}},ne=()=>{s.value.coverImage=""},re=()=>{S.logout(),m.success("退出成功"),J.push("/login")};return fe(()=>{S.initUser(),I(),H()}),(o,e)=>{const n=r("el-menu-item"),g=r("el-menu"),i=r("el-button"),A=r("el-header"),R=r("el-icon"),y=r("el-option"),z=r("el-select"),N=r("el-col"),O=r("el-input"),ue=r("el-row"),_=r("el-table-column"),de=r("el-tag"),ie=r("el-table"),ce=r("el-pagination"),me=r("el-main"),f=r("el-form-item"),q=r("el-input-number"),pe=r("el-upload"),ge=r("el-form"),ve=r("el-dialog");return c(),k("div",ze,[t(A,{class:"header"},{default:a(()=>[d("div",Le,[e[24]||(e[24]=d("div",{class:"logo"},[d("h2",null,"商家后台管理系统")],-1)),t(g,{mode:"horizontal",router:!0,class:"nav-menu"},{default:a(()=>[t(n,{index:"/merchant"},{default:a(()=>[...e[17]||(e[17]=[u("首页",-1)])]),_:1}),t(n,{index:"/merchant/products"},{default:a(()=>[...e[18]||(e[18]=[u("商品管理",-1)])]),_:1}),t(n,{index:"/merchant/orders"},{default:a(()=>[...e[19]||(e[19]=[u("订单管理",-1)])]),_:1}),t(n,{index:"/merchant/categories"},{default:a(()=>[...e[20]||(e[20]=[u("分类管理",-1)])]),_:1}),t(n,{index:"/merchant/banners"},{default:a(()=>[...e[21]||(e[21]=[u("轮播管理",-1)])]),_:1})]),_:1}),d("div",Ee,[x(S).isLoggedIn()?(c(),k(h,{key:0},[d("span",null,"欢迎，"+L(x(S).user?.nickname||x(S).user?.username),1),t(i,{onClick:re,type:"text"},{default:a(()=>[...e[22]||(e[22]=[u("退出",-1)])]),_:1})],64)):(c(),V(i,{key:1,onClick:e[0]||(e[0]=l=>o.$router.push("/login")),type:"primary"},{default:a(()=>[...e[23]||(e[23]=[u("登录",-1)])]),_:1}))])])]),_:1}),t(me,{class:"main-content"},{default:a(()=>[d("div",Pe,[d("div",Ae,[e[26]||(e[26]=d("h2",null,"商品管理",-1)),t(i,{type:"primary",onClick:e[1]||(e[1]=l=>C.value=!0)},{default:a(()=>[t(R,null,{default:a(()=>[t(x(D))]),_:1}),e[25]||(e[25]=u(" 添加商品 ",-1))]),_:1})]),d("div",Ne,[t(ue,{gutter:20},{default:a(()=>[t(N,{span:6},{default:a(()=>[t(z,{modelValue:v.categoryId,"onUpdate:modelValue":e[2]||(e[2]=l=>v.categoryId=l),placeholder:"选择分类",clearable:"",onChange:F},{default:a(()=>[(c(!0),k(h,null,G(E.value,l=>(c(),V(y,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(N,{span:6},{default:a(()=>[t(z,{modelValue:v.status,"onUpdate:modelValue":e[3]||(e[3]=l=>v.status=l),placeholder:"商品状态",clearable:"",onChange:F},{default:a(()=>[t(y,{label:"在售",value:"ON_SALE"}),t(y,{label:"下架",value:"OFF_SALE"}),t(y,{label:"缺货",value:"OUT_OF_STOCK"})]),_:1},8,["modelValue"])]),_:1}),t(N,{span:6},{default:a(()=>[t(O,{modelValue:v.keyword,"onUpdate:modelValue":e[4]||(e[4]=l=>v.keyword=l),placeholder:"搜索商品名称",clearable:"",onKeyup:ye(F,["enter"])},{append:a(()=>[t(i,{onClick:F},{default:a(()=>[...e[27]||(e[27]=[u("搜索",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),d("div",Te,[t(ie,{data:U.value,style:{width:"100%"}},{default:a(()=>[t(_,{prop:"id",label:"ID",width:"80"}),t(_,{label:"商品图片",width:"100"},{default:a(l=>[d("div",he,[l.row.coverImage?(c(),k("img",{key:0,src:l.row.coverImage,alt:l.row.name,class:"product-image"},null,8,Me)):(c(),k("div",$e,"无图片"))])]),_:1}),t(_,{prop:"name",label:"商品名称",width:"200"}),t(_,{prop:"subtitle",label:"副标题",width:"150"}),t(_,{prop:"price",label:"价格",width:"100"},{default:a(l=>[u(" ¥"+L(l.row.price),1)]),_:1}),t(_,{prop:"stock",label:"库存",width:"80"}),t(_,{prop:"status",label:"状态",width:"100"},{default:a(l=>[t(de,{type:le(l.row.status)},{default:a(()=>[u(L(ae(l.row.status)),1)]),_:2},1032,["type"])]),_:1}),t(_,{prop:"createdAt",label:"创建时间",width:"180"}),t(_,{label:"操作",width:"200"},{default:a(l=>[t(i,{size:"small",onClick:T=>Y(l.row)},{default:a(()=>[...e[28]||(e[28]=[u(" 编辑 ",-1)])]),_:2},1032,["onClick"]),l.row.status==="ON_SALE"?(c(),V(i,{key:0,size:"small",type:"warning",onClick:T=>B(l.row.id,"OFF_SALE")},{default:a(()=>[...e[29]||(e[29]=[u(" 下架 ",-1)])]),_:2},1032,["onClick"])):(c(),V(i,{key:1,size:"small",type:"success",onClick:T=>B(l.row.id,"ON_SALE")},{default:a(()=>[...e[30]||(e[30]=[u(" 上架 ",-1)])]),_:2},1032,["onClick"])),t(i,{size:"small",type:"danger",onClick:T=>ee(l.row.id)},{default:a(()=>[...e[31]||(e[31]=[u(" 删除 ",-1)])]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),d("div",Be,[t(ce,{"current-page":p.page,"onUpdate:currentPage":e[5]||(e[5]=l=>p.page=l),"page-size":p.size,"onUpdate:pageSize":e[6]||(e[6]=l=>p.size=l),total:p.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Q,onCurrentChange:X},null,8,["current-page","page-size","total"])])])]),_:1}),t(ve,{modelValue:C.value,"onUpdate:modelValue":e[16]||(e[16]=l=>C.value=l),title:b.value?"编辑商品":"添加商品",width:"800px"},{footer:a(()=>[t(i,{onClick:e[15]||(e[15]=l=>C.value=!1)},{default:a(()=>[...e[34]||(e[34]=[u("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:Z,loading:P.value},{default:a(()=>[u(L(b.value?"更新":"添加"),1)]),_:1},8,["loading"])]),default:a(()=>[t(ge,{ref_key:"productFormRef",ref:$,model:s.value,rules:W,"label-width":"100px"},{default:a(()=>[t(f,{label:"商品名称",prop:"name"},{default:a(()=>[t(O,{modelValue:s.value.name,"onUpdate:modelValue":e[7]||(e[7]=l=>s.value.name=l),placeholder:"请输入商品名称"},null,8,["modelValue"])]),_:1}),t(f,{label:"副标题",prop:"subtitle"},{default:a(()=>[t(O,{modelValue:s.value.subtitle,"onUpdate:modelValue":e[8]||(e[8]=l=>s.value.subtitle=l),placeholder:"请输入商品副标题"},null,8,["modelValue"])]),_:1}),t(f,{label:"商品分类",prop:"categoryId"},{default:a(()=>[t(z,{modelValue:s.value.categoryId,"onUpdate:modelValue":e[9]||(e[9]=l=>s.value.categoryId=l),placeholder:"请选择商品分类"},{default:a(()=>[(c(!0),k(h,null,G(E.value,l=>(c(),V(y,{key:l.id,label:l.name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(f,{label:"商品价格",prop:"price"},{default:a(()=>[t(q,{modelValue:s.value.price,"onUpdate:modelValue":e[10]||(e[10]=l=>s.value.price=l),precision:2,step:.01,min:0,placeholder:"请输入商品价格"},null,8,["modelValue"])]),_:1}),t(f,{label:"商品库存",prop:"stock"},{default:a(()=>[t(q,{modelValue:s.value.stock,"onUpdate:modelValue":e[11]||(e[11]=l=>s.value.stock=l),min:0,precision:0,placeholder:"请输入商品库存"},null,8,["modelValue"])]),_:1}),t(f,{label:"计量单位",prop:"unit"},{default:a(()=>[t(O,{modelValue:s.value.unit,"onUpdate:modelValue":e[12]||(e[12]=l=>s.value.unit=l),placeholder:"如：包、袋、瓶等"},null,8,["modelValue"])]),_:1}),t(f,{label:"商品图片",prop:"coverImage"},{default:a(()=>[d("div",Re,[t(pe,{class:"image-uploader","show-file-list":!1,"before-upload":oe,"http-request":se,accept:"image/*"},{default:a(()=>[s.value.coverImage?(c(),k("img",{key:0,src:s.value.coverImage,class:"uploaded-image"},null,8,qe)):(c(),V(R,{key:1,class:"image-uploader-icon"},{default:a(()=>[t(x(D))]),_:1}))]),_:1}),d("div",Ke,[e[33]||(e[33]=d("p",null,"支持 JPG、PNG、GIF 格式，文件大小不超过 5MB",-1)),s.value.coverImage?(c(),V(i,{key:0,type:"danger",size:"small",onClick:ne},{default:a(()=>[...e[32]||(e[32]=[u("删除图片",-1)])]),_:1})):be("",!0)])])]),_:1}),t(f,{label:"商品描述",prop:"description"},{default:a(()=>[t(O,{modelValue:s.value.description,"onUpdate:modelValue":e[13]||(e[13]=l=>s.value.description=l),type:"textarea",rows:4,placeholder:"请输入商品详细描述"},null,8,["modelValue"])]),_:1}),t(f,{label:"商品状态",prop:"status"},{default:a(()=>[t(z,{modelValue:s.value.status,"onUpdate:modelValue":e[14]||(e[14]=l=>s.value.status=l),placeholder:"请选择商品状态"},{default:a(()=>[t(y,{label:"在售",value:"ON_SALE"}),t(y,{label:"下架",value:"OFF_SALE"}),t(y,{label:"缺货",value:"OUT_OF_STOCK"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),Ye=Fe(De,[["__scopeId","data-v-568aaed9"]]);export{Ye as default};
